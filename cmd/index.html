<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta http-equiv="x-ua-compatible" content="ie=edge"/>
    <title>BS-SPEKE Login Demo</title>
    <!-- MDB icon -->
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"/>
    <!-- Google Fonts Roboto -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap"/>
    <!-- MDB -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"/>
</head>

<body>
<!-- Start your project here-->
<style>
    .btn-color {
        background-color: #0e1c36;
        color: #fff;

    }

    .profile-image-pic {
        height: 200px;
        width: 200px;
        object-fit: cover;
    }


    .cardbody-color {
        background-color: #ebf2fa;
    }

    a {
        text-decoration: none;
    }
</style>
<div class="container">
    <div class="row">
        <div class="col-md-6 offset-md-3">
            <h2 class="text-center text-dark mt-5">Login Form</h2>
            <div class="text-center mb-5 text-dark">Made with bootstrap</div>
            <div class="card my-5">

                <form class="card-body cardbody-color p-lg-5">

                    <div class="text-center">
                        <img src="https://cdn.pixabay.com/photo/2016/03/31/19/56/avatar-1295397__340.png"
                             class="img-fluid profile-image-pic img-thumbnail rounded-circle my-3"
                             width="200px" alt="profile">
                    </div>

                    <div class="mb-3">
                        <input type="text" class="form-control" id="username" aria-describedby="emailHelp" placeholder="Username">
                    </div>
                    <div class="mb-3">
                        <input type="password" class="form-control" id="password" placeholder="Password">
                    </div>
                    <div class="text-center">
                        <button id="login" class="btn btn-color px-5 mb-3 w-100">Login</button>
                    </div>
                    <div class="text-center">
                        <button id="register" class="btn btn-color px-5 mb-3 w-100">Register</button>
                    </div>
                    <div id="emailHelp" class="form-text text-center mb-5 text-dark">
                        Not Registered?
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<script>
    const serverID = "test server";
    const generatorModifier = "generator modifier";
    const privateKeyModifier = "private key modifier";
    let sodium = undefined;
    window.sodium = {
        onload: function (sodium_) {
            sodium = sodium_;
        }
    };

    function credentials() {
        let username = document.getElementById('username').value;
        let password = document.getElementById('password').value;
        return [username, password];
    }

    function login(e) {
        e.preventDefault();
    }

    function registerStep1(username, password) {
        // generate blind salt
        let salt = sodium.crypto_generichash(64, sodium.from_string(password), sodium.from_string(serverID));
        salt = sodium.crypto_core_ristretto255_from_hash(salt);
        let mask = sodium.crypto_core_ristretto255_scalar_random();
        salt = sodium.crypto_scalarmult_ristretto255(mask, salt);
        mask = sodium.crypto_core_ristretto255_scalar_invert(mask);

        let request = {
            "salt": sodium.to_base64(salt),
            "username": username,
        };

        return [request, mask];
    }

    function registerStep2(username, password, mask, salt, blob) {
        salt = sodium.from_base64(salt);

        if (!sodium.crypto_core_ristretto255_is_valid_point(salt)) {
            throw "invalid salt";
        }

        let blindSalt = sodium.crypto_scalarmult_ristretto255(mask, salt);
        blindSalt = sodium.crypto_generichash(sodium.crypto_pwhash_SALTBYTES, blindSalt, sodium.from_string(serverID));

        let keyMaterial = sodium.crypto_pwhash(64, sodium.from_string(password), blindSalt,
            sodium.crypto_pwhash_OPSLIMIT_INTERACTIVE, sodium.crypto_pwhash_MEMLIMIT_MODERATE, sodium.crypto_pwhash_ALG_DEFAULT);

        let generator = sodium.crypto_generichash(sodium.crypto_core_ristretto255_HASHBYTES,
            keyMaterial, sodium.from_string(generatorModifier));
        generator = sodium.crypto_core_ristretto255_from_hash(generator);

        let privateKey = sodium.crypto_generichash(sodium.crypto_core_ristretto255_HASHBYTES,
            keyMaterial, sodium.from_string(privateKeyModifier));
        privateKey = sodium.crypto_core_ristretto255_scalar_reduce(privateKey);

        sodium.memzero(keyMaterial);

        let publicKey = sodium.crypto_scalarmult_ristretto255(privateKey, generator);
        sodium.memzero(privateKey);

        return {
            "username": username,
            "generator": sodium.to_base64(generator),
            "publicKey": sodium.to_base64(publicKey),
            "blob": blob,
        };
    }

    async function register(e) {
        e.preventDefault();
        let [username, password] = credentials();
        console.log('register ' + username + " " + password);
        let [request1, mask] = registerStep1(username, password)
        console.log("mask:", sodium.to_base64(mask));
        let resp = await fetch("/register/step1", {
            method: "POST",
            body: JSON.stringify(request1),
        });
        let respJson = await resp.json();
        let request2 = registerStep2(username, password, mask, respJson.salt, respJson.blob);
        resp = await fetch("/register/step2", {
            method: "POST",
            body: JSON.stringify(request2),
        });
       respJson = await resp.json();
    }

    document.getElementById('register').addEventListener('click', register);
    document.getElementById('login').addEventListener('click', login);
</script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"></script>
<script src="sodium.js" async></script>
</body>

</html>